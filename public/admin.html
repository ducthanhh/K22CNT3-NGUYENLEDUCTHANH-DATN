<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ Thống Quản Trị |  Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
:root {
    --primary: #0a2540;
    --gold: #d4af37;
    --gold-hover: #b8962d;
    --bg-body: #f0f2f5;
    --white: #ffffff;
    --text-main: #2c3e50;
    --sidebar-width: 260px;
    --shadow: 0 8px 30px rgba(0,0,0,0.08);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-body);
    color: var(--text-main);
    display: flex;
    height: 100vh;
}

/* SIDEBAR - RE-DESIGN */
.sidebar {
    width: var(--sidebar-width);
    background: var(--primary);
    padding: 30px 15px;
    display: flex;
    flex-direction: column;
    box-shadow: 4px 0 15px rgba(0,0,0,0.1);
    z-index: 100;
}

.sidebar h2 {
    color: var(--gold);
    font-size: 1.4rem;
    letter-spacing: 2px;
    text-align: center;
    margin-bottom: 50px;
    border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    padding-bottom: 20px;
}

.menu-item {
    display: flex;
    align-items: center;
    color: rgba(255,255,255,0.7);
    padding: 14px 20px;
    text-decoration: none;
    border-radius: 12px;
    margin-bottom: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 400;
}

.menu-item i {
    font-size: 1.1rem;
    margin-right: 15px;
    width: 20px;
    text-align: center;
}

.menu-item:hover {
    background: rgba(212, 175, 55, 0.1);
    color: var(--gold);
}

.menu-item.active {
    background: var(--gold);
    color: var(--primary);
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
}

/* MAIN CONTENT */
.main-content {
    flex: 1;
    padding: 40px;
    overflow-y: auto;
    scroll-behavior: smooth;
}

h1 {
    font-size: 1.8rem;
    margin-bottom: 30px;
    color: var(--primary);
    font-weight: 600;
}

/* STATS CARDS */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

.card {
    background: var(--white);
    padding: 25px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
    border: 1px solid rgba(255,255,255,0.3);
}

.card:hover { transform: translateY(-5px); }

.card i {
    width: 60px;
    height: 60px;
    background: rgba(212, 175, 55, 0.1);
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: var(--gold);
    margin-right: 20px;
}

.card h3 { font-size: 1.6rem; color: var(--primary); }
.card p { color: #7f8c8d; font-size: 0.9rem; }

/* FORMS */
.form-card {
    background: var(--white);
    padding: 35px;
    border-radius: 20px;
    box-shadow: var(--shadow);
    margin-bottom: 40px;
}

.form-group label {
    font-size: 0.9rem;
    margin-bottom: 8px;
    color: var(--primary);
    display: block;
    font-weight: 500;
}

.form-group input, .form-group select {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    padding: 12px 15px;
    border-radius: 10px;
    transition: all 0.3s;
}

.form-group input:focus {
    border-color: var(--gold);
    background: white;
    outline: none;
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
}

.btn-submit {
    background: var(--primary);
    padding: 14px 30px;
    border-radius: 10px;
    transition: 0.3s;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.btn-submit:hover {
    background: #143d63;
    box-shadow: 0 5px 15px rgba(114, 165, 215, 0.3);
}

/* TABLES */
table {
    width: 100%;
    background: var(--white);
    border-radius: 20px;
    border-collapse: separate;
    border-spacing: 0;
    overflow: hidden;
    box-shadow: var(--shadow);
}

th {
    background: #f8f9fa;
    color: #5d6d7e;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 1px;
    padding: 20px;
    border-bottom: 1px solid #edf2f7;
}

td {
    padding: 18px 20px;
    border-bottom: 1px solid #edf2f7;
    font-size: 0.9rem;
}

tr:last-child td { border-bottom: none; }

/* BADGES */
.badge {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 0.75rem;
    text-transform: uppercase;
}

.bg-green { background: #e6fffa; color: #2d3748; border: 1px solid #81e6d9; }
.bg-red { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }
.bg-yellow { background: #fffaf0; color: #975a16; border: 1px solid #fbd38d; }

/* ACTION BUTTONS */
.action-btn {
    border-radius: 8px;
    font-weight: 500;
    transition: 0.2s;
}

.btn-approve { background: #38a169; }
.btn-cancel { background: #e53e3e; }

/* ANIMATION */
.section-tab {
    display: none;
    animation: slideIn 0.4s ease-out;
}
.section-tab.active { display: block; }

@keyframes slideIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}
    </style>
</head>
<body>

    <div class="sidebar">
        <h2> ADMIN</h2>
        <div class="menu-item active" onclick="showTab('dashboard', this)"><i class="fas fa-home"></i> Tổng Quan</div>
        <div class="menu-item" onclick="showTab('ships', this)"><i class="fas fa-ship"></i> Quản Lý Tàu</div>
        <div class="menu-item" onclick="showTab('schedules', this)"><i class="fas fa-calendar-alt"></i> Quản Lý Lịch Trình</div>
        <div class="menu-item" onclick="showTab('bookings', this)"><i class="fas fa-ticket-alt"></i> Quản Lý Vé</div>
        <div class="menu-item" onclick="showTab('contracts', this)"> <i class="fas fa-file-contract"></i> Quản Lý Hợp Đồng</div>
        <div class="menu-item" onclick="showTab('customers', this)"><i class="fas fa-users"></i> Quản Lý Khách Hàng</div>


        <a href="/logout" class="menu-item" style="margin-top: auto; background: rgba(255,0,0,0.1); color: #ff6b6b;"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</a>
    </div>

    <div class="main-content">
        
        <div id="tab-dashboard" class="section-tab active">
            <h1>Tổng Quan Hệ Thống</h1>
            <div class="stats-container">
                <div class="card"><i class="fas fa-ship"></i><div><h3 id="stat-ships">0</h3><p>Tổng Số Tàu</p></div></div>
                <div class="card"><i class="fas fa-ticket-alt"></i><div><h3 id="stat-tickets">0</h3><p>Vé Đã Bán</p></div></div>
                <div class="card"><i class="fas fa-coins"></i><div><h3 id="stat-revenue">0 ₫</h3><p>Doanh Thu</p></div></div>
            </div>
        </div>

        <div id="tab-ships" class="section-tab">
            <h1>Quản Lý Đội Tàu</h1>
            
            <div class="form-card form-container">
                <h3>+ Thêm Tàu Mới</h3>
                <form action="/admin/add-ship" method="POST">
                    <div class="form-group">
                        <label>Tên Tàu</label>
                        <input type="text" name="ship_name" placeholder="Ví dụ: Ocean Dream 09" required>
                    </div>
                    <div class="form-group">
                        <label>Sức Chứa (Số ghế)</label>
                        <input type="number" name="capacity" placeholder="50" required>
                    </div>
                    <button type="submit" class="btn-submit">Lưu Tàu Mới</button>
                </form>
            </div>

            <h3>Danh Sách Tàu Hiện Có</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tên Tàu</th>
                        <th>Loại Tàu</th>
                        <th>Sức Chứa</th>
                        <th>Trạng Thái</th>
                    </tr>
                </thead>
                <tbody id="ship-list-body">
                    </tbody>
            </table>
        </div>

        <div id="tab-schedules" class="section-tab">
            <h1>Quản Lý Lịch Trình</h1>
            <div class="form-card form-container">
                <h3>+ Tạo Chuyến Đi Mới</h3>
                <form action="/admin/add-schedule" method="POST">
                    <div class="form-group">
                        <label>Chọn Tàu</label>
                        <select name="ship_id" id="select-ships" required></select>
                    </div>
                    <div class="form-group">
                        <label>Chọn Tuyến Đi</label>
                        <select name="route_id" id="select-routes" required></select>
                    </div>
                    <div class="form-group" style="display:flex; gap:10px;">
                        <div style="flex:1">
                            <label>Giờ Khởi Hành</label>
                            <input type="datetime-local" name="departure_time" required>
                        </div>
                        <div style="flex:1">
                            <label>Giờ Đến (Dự kiến)</label>
                            <input type="datetime-local" name="arrival_time" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Giá Vé Gốc (VNĐ)</label>
                        <input type="number" name="price" placeholder="Ví dụ: 1500000" required>
                    </div>
                    <button type="submit" class="btn-submit">Lên Lịch Ngay</button>
                </form>
            </div>
        </div>

        <div id="tab-bookings" class="section-tab">
            <h1>Danh Sách Vé Đặt</h1>
            <table>
                <thead>
                    <tr>
                        <th>Mã Vé</th>
                        <th>Khách Hàng</th>
                        <th>Ngày Đặt</th>
                        <th>Số Lượng</th>
                        <th>Tổng Tiền</th>
                        <th>Trạng Thái</th>
                        <th>Hành Động</th>
                    </tr>
                </thead>
                <tbody id="booking-list">
                    </tbody>
            </table>
        </div>

          <div id="tab-contracts" class="section-tab">
    <h1>Danh Sách Hợp Đồng</h1>

    <table>
        <thead>
            <tr>
                <th>Mã HĐ</th>
                <th>Mã Booking</th>
                <th>Khách Hàng</th>
                <th>Email</th>
                <th>Tổng Tiền</th>
                <th>Trạng Thái</th>
                <th>Ngày Chấp Thuận</th>
            </tr>
        </thead>
        <tbody id="contract-list">
        </tbody>
    </table>
</div>
<div id="tab-customers" class="section-tab">
    <h1>Quản Lý Khách Hàng</h1>

    <!-- THỐNG KÊ -->
    <div class="stats-container">
        <div class="card">
            <i class="fas fa-users"></i>
            <div>
                <h3 id="stat-customers">0</h3>
                <p>Tổng Khách Hàng</p>
            </div>
        </div>

        <div class="card">
            <i class="fas fa-ticket-alt"></i>
            <div>
                <h3 id="stat-top-booking">-</h3>
                <p>Khách Đặt Nhiều Nhất</p>
            </div>
        </div>

        <div class="card">
            <i class="fas fa-coins"></i>
            <div>
                <h3 id="stat-top-spent">-</h3>
                <p>Khách Chi Nhiều Nhất</p>
            </div>
        </div>
    </div>

    <!-- BẢNG KHÁCH -->
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Tên Khách</th>
                <th>Email</th>
                <th>SĐT</th>
                <th>Số Lần Đặt</th>
                <th>Tổng Chi</th>
                <th>Chi Tiết</th>
            </tr>
        </thead>
        <tbody id="customer-list"></tbody>
    </table>
</div>

    </div>
  


    <script>
     

        // TẢI DỮ LIỆU KHI TRANG LOAD
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadShipsList(); // Mới thêm
            loadBookings();
            loadResourcesForForms();
        });

        // 1. Tải Thống kê
        function loadStats() {
            fetch('/api/admin/stats').then(res => res.json()).then(data => {
                document.getElementById('stat-ships').innerText = data.ships;
                document.getElementById('stat-tickets').innerText = data.tickets;
                document.getElementById('stat-revenue').innerText = Number(data.revenue).toLocaleString() + ' ₫';
            });
        }

        // 2. Tải Danh sách Tàu (MỚI)
        function loadShipsList() {
            fetch('/api/admin/ships').then(res => res.json()).then(data => {
                const tbody = document.getElementById('ship-list-body');
                tbody.innerHTML = data.map(ship => `
                    <tr>
                        <td>#${ship.ship_id}</td>
                        <td style="font-weight:bold; color:#0a2540">${ship.ship_name}</td>
                        <td>${ship.type_id == 1 ? 'Hạng Sang (Luxury)' : 'Thường'}</td>
                        <td>${ship.capacity} ghế</td>
                        <td><span class="badge bg-green">Hoạt động</span></td>
                    </tr>
                `).join('');
            });
        }

        // 3. Tải Danh sách Vé
        function loadBookings() {
            fetch('/api/all-bookings').then(res => res.json()).then(data => {
                const tbody = document.getElementById('booking-list');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">Chưa có vé nào được đặt.</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map(b => {
                    let statusClass = 'bg-yellow';
                    let statusText = 'Chờ thanh toán';
                    if (b.status === 'confirmed') { statusClass = 'bg-green'; statusText = 'Đã thanh toán'; }
                    if (b.status === 'cancelled') { statusClass = 'bg-red'; statusText = 'Đã hủy'; }

                    return `
                    <tr>
                        <td>#${b.booking_id}</td>
                        <td>${b.full_name}</td>
                        <td>${new Date(b.booking_date).toLocaleDateString()}</td>
                        <td>${b.number_of_tickets}</td>
                        <td>${Number(b.total_price).toLocaleString()} ₫</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            ${b.status !== 'cancelled' ? `<button class="action-btn btn-cancel" onclick="updateStatus(${b.booking_id}, 'cancelled')">Hủy</button>` : ''}
                            ${b.status === 'pending' ? `<button class="action-btn btn-approve" onclick="updateStatus(${b.booking_id}, 'confirmed')">Duyệt</button>` : ''}
                        </td>
                    </tr>
                    `;
                }).join('');
            });
        }

        // 4. Tải Tàu & Tuyến vào ô Select
        function loadResourcesForForms() {
            fetch('/api/admin/resources').then(res => res.json()).then(data => {
                const shipSelect = document.getElementById('select-ships');
                shipSelect.innerHTML = data.ships.map(s => `<option value="${s.ship_id}">${s.ship_name} (${s.capacity} chỗ)</option>`).join('');
                
                const routeSelect = document.getElementById('select-routes');
                routeSelect.innerHTML = data.routes.map(r => `<option value="${r.route_id}">${r.from_city} ➝ ${r.to_city}</option>`).join('');
            });
        }

        // 5. Xử lý nút Duyệt/Hủy
        function updateStatus(id, newStatus) {
            if(!confirm('Bạn có chắc chắn muốn thay đổi trạng thái vé #' + id + '?')) return;
            fetch('/admin/update-booking-status', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `booking_id=${id}&status=${newStatus}`
            }).then(() => {
                loadBookings(); // Tải lại bảng sau khi bấm
                loadStats();
            });
        }

        function loadContracts() {
    fetch('/api/admin/contracts')
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById('contract-list');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">Chưa có hợp đồng.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(c => `
                <tr>
                    <td>#${c.contract_id}</td>
                    <td>#${c.booking_id}</td>
                    <td>${c.full_name}</td>
                    <td>${c.email}</td>
                    <td>${Number(c.total_price).toLocaleString()} ₫</td>
                    <td>
                        <span class="badge ${c.accepted ? 'bg-green' : 'bg-yellow'}">
                            ${c.accepted ? 'Đã chấp thuận' : 'Chưa chấp thuận'}
                        </span>
                    </td>
                    <td>
                        ${c.accepted_at ? new Date(c.accepted_at).toLocaleString() : '-'}
                    </td>
                </tr>
            `).join('');
        });
}
function showTab(tabName, element) {
    document.querySelectorAll('.section-tab').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));

    document.getElementById('tab-' + tabName).classList.add('active');
    element.classList.add('active');

    if (tabName === 'contracts') {
        loadContracts();
    }

    if (tabName === 'customers') {
        loadCustomers();
        loadCustomerStats();
    }
}


function loadCustomers() {
    fetch('/api/admin/customers')
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById('customer-list');

            tbody.innerHTML = data.map(c => `
                <tr>
                    <td>#${c.user_id}</td>
                    <td>${c.full_name}</td>
                    <td>${c.email}</td>
                    <td>${c.phone}</td>
                    <td>${c.total_bookings}</td>
                    <td>${Number(c.total_spent).toLocaleString()} ₫</td>
                    <td>
                        <button class="action-btn btn-approve"
                            onclick="viewCustomer(${c.user_id})">
                            Xem
                        </button>
                    </td>
                </tr>
            `).join('');
        });
}

function loadCustomerStats() {
    fetch('/api/admin/customer-stats')
        .then(res => res.json())
        .then(data => {
            document.getElementById('stat-customers').innerText = data.total_customers;

            document.getElementById('stat-top-booking').innerText =
                data.top_booking_customer
                ? data.top_booking_customer.full_name
                : '-';

            document.getElementById('stat-top-spent').innerText =
                data.top_spent_customer
                ? data.top_spent_customer.full_name
                : '-';
        });
}

function viewCustomer(id) {
    fetch('/api/admin/customer/' + id)
        .then(res => res.json())
        .then(data => {
            if (!data) return alert('Không tìm thấy khách');

            let text = `
Tên: ${data.customer.full_name}
Email: ${data.customer.email}
SĐT: ${data.customer.phone}

--- DANH SÁCH VÉ ---
`;

            data.bookings.forEach(b => {
                text += `
#${b.booking_id} | ${b.status} | ${Number(b.total_price).toLocaleString()} ₫
`;
            });

            alert(text);
        });
}

    </script>
</body>
</html>