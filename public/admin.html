<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ Thống Quản Trị | Ocean Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS CƠ BẢN */
        :root { --primary: #0a2540; --gold: #d4af37; --light: #f4f6f8; }
        body { font-family: 'Poppins', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--primary); color: white; padding: 20px; display: flex; flex-direction: column; }
        .sidebar h2 { color: var(--gold); text-align: center; margin-bottom: 40px; }
        .menu-item { display: block; color: rgba(255,255,255,0.8); padding: 15px; text-decoration: none; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: var(--gold); color: var(--primary); font-weight: bold; }
        .menu-item i { width: 25px; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        .section-tab { display: none; animation: fadeIn 0.5s; } /* Ẩn hết, chỉ hiện cái được chọn */
        .section-tab.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* FORMS & TABLES */
        .form-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); max-width: 100%; margin-bottom: 30px; }
        .form-container { max-width: 600px; } /* Form nhập liệu thì nhỏ thôi */
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary); }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; }
        .btn-submit { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #e9ecef; color: var(--primary); font-weight: bold; }
        tr:hover { background-color: #f8f9fa; }
        
        /* STATUS BADGES */
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; }
        .bg-green { background: #d4edda; color: #155724; }
        .bg-red { background: #f8d7da; color: #721c24; }
        .bg-yellow { background: #fff3cd; color: #856404; }

        .action-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.8rem; margin-right: 5px;}
        .btn-approve { background: #28a745; }
        .btn-cancel { background: #dc3545; }
        
        /* STATS CARDS */
        .stats-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 15px; display: flex; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .card i { font-size: 30px; margin-right: 20px; color: var(--gold); }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>OCEAN ADMIN</h2>
        <div class="menu-item active" onclick="showTab('dashboard', this)"><i class="fas fa-home"></i> Tổng Quan</div>
        <div class="menu-item" onclick="showTab('ships', this)"><i class="fas fa-ship"></i> Quản Lý Tàu</div>
        <div class="menu-item" onclick="showTab('schedules', this)"><i class="fas fa-calendar-alt"></i> Quản Lý Lịch Trình</div>
        <div class="menu-item" onclick="showTab('bookings', this)"><i class="fas fa-ticket-alt"></i> Quản Lý Vé</div>
        <a href="/logout" class="menu-item" style="margin-top: auto; background: rgba(255,0,0,0.1); color: #ff6b6b;"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</a>
    </div>

    <div class="main-content">
        
        <div id="tab-dashboard" class="section-tab active">
            <h1>Tổng Quan Hệ Thống</h1>
            <div class="stats-container">
                <div class="card"><i class="fas fa-ship"></i><div><h3 id="stat-ships">0</h3><p>Tổng Số Tàu</p></div></div>
                <div class="card"><i class="fas fa-ticket-alt"></i><div><h3 id="stat-tickets">0</h3><p>Vé Đã Bán</p></div></div>
                <div class="card"><i class="fas fa-coins"></i><div><h3 id="stat-revenue">0 ₫</h3><p>Doanh Thu</p></div></div>
            </div>
        </div>

        <div id="tab-ships" class="section-tab">
            <h1>Quản Lý Đội Tàu</h1>
            
            <div class="form-card form-container">
                <h3>+ Thêm Tàu Mới</h3>
                <form action="/admin/add-ship" method="POST">
                    <div class="form-group">
                        <label>Tên Tàu</label>
                        <input type="text" name="ship_name" placeholder="Ví dụ: Ocean Dream 09" required>
                    </div>
                    <div class="form-group">
                        <label>Sức Chứa (Số ghế)</label>
                        <input type="number" name="capacity" placeholder="50" required>
                    </div>
                    <button type="submit" class="btn-submit">Lưu Tàu Mới</button>
                </form>
            </div>

            <h3>Danh Sách Tàu Hiện Có</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tên Tàu</th>
                        <th>Loại Tàu</th>
                        <th>Sức Chứa</th>
                        <th>Trạng Thái</th>
                    </tr>
                </thead>
                <tbody id="ship-list-body">
                    </tbody>
            </table>
        </div>

        <div id="tab-schedules" class="section-tab">
            <h1>Quản Lý Lịch Trình</h1>
            <div class="form-card form-container">
                <h3>+ Tạo Chuyến Đi Mới</h3>
                <form action="/admin/add-schedule" method="POST">
                    <div class="form-group">
                        <label>Chọn Tàu</label>
                        <select name="ship_id" id="select-ships" required></select>
                    </div>
                    <div class="form-group">
                        <label>Chọn Tuyến Đi</label>
                        <select name="route_id" id="select-routes" required></select>
                    </div>
                    <div class="form-group" style="display:flex; gap:10px;">
                        <div style="flex:1">
                            <label>Giờ Khởi Hành</label>
                            <input type="datetime-local" name="departure_time" required>
                        </div>
                        <div style="flex:1">
                            <label>Giờ Đến (Dự kiến)</label>
                            <input type="datetime-local" name="arrival_time" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Giá Vé Gốc (VNĐ)</label>
                        <input type="number" name="price" placeholder="Ví dụ: 1500000" required>
                    </div>
                    <button type="submit" class="btn-submit">Lên Lịch Ngay</button>
                </form>
            </div>
        </div>

        <div id="tab-bookings" class="section-tab">
            <h1>Danh Sách Vé Đặt</h1>
            <table>
                <thead>
                    <tr>
                        <th>Mã Vé</th>
                        <th>Khách Hàng</th>
                        <th>Ngày Đặt</th>
                        <th>Số Lượng</th>
                        <th>Tổng Tiền</th>
                        <th>Trạng Thái</th>
                        <th>Hành Động</th>
                    </tr>
                </thead>
                <tbody id="booking-list">
                    </tbody>
            </table>
        </div>

    </div>

    <script>
        // HÀM CHUYỂN TAB
        function showTab(tabName, element) {
            document.querySelectorAll('.section-tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            element.classList.add('active');
        }

        // TẢI DỮ LIỆU KHI TRANG LOAD
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadShipsList(); // Mới thêm
            loadBookings();
            loadResourcesForForms();
        });

        // 1. Tải Thống kê
        function loadStats() {
            fetch('/api/admin/stats').then(res => res.json()).then(data => {
                document.getElementById('stat-ships').innerText = data.ships;
                document.getElementById('stat-tickets').innerText = data.tickets;
                document.getElementById('stat-revenue').innerText = Number(data.revenue).toLocaleString() + ' ₫';
            });
        }

        // 2. Tải Danh sách Tàu (MỚI)
        function loadShipsList() {
            fetch('/api/admin/ships').then(res => res.json()).then(data => {
                const tbody = document.getElementById('ship-list-body');
                tbody.innerHTML = data.map(ship => `
                    <tr>
                        <td>#${ship.ship_id}</td>
                        <td style="font-weight:bold; color:#0a2540">${ship.ship_name}</td>
                        <td>${ship.type_id == 1 ? 'Hạng Sang (Luxury)' : 'Thường'}</td>
                        <td>${ship.capacity} ghế</td>
                        <td><span class="badge bg-green">Hoạt động</span></td>
                    </tr>
                `).join('');
            });
        }

        // 3. Tải Danh sách Vé
        function loadBookings() {
            fetch('/api/all-bookings').then(res => res.json()).then(data => {
                const tbody = document.getElementById('booking-list');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">Chưa có vé nào được đặt.</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map(b => {
                    let statusClass = 'bg-yellow';
                    let statusText = 'Chờ thanh toán';
                    if (b.status === 'confirmed') { statusClass = 'bg-green'; statusText = 'Đã thanh toán'; }
                    if (b.status === 'cancelled') { statusClass = 'bg-red'; statusText = 'Đã hủy'; }

                    return `
                    <tr>
                        <td>#${b.booking_id}</td>
                        <td>${b.full_name}</td>
                        <td>${new Date(b.booking_date).toLocaleDateString()}</td>
                        <td>${b.number_of_tickets}</td>
                        <td>${Number(b.total_price).toLocaleString()} ₫</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            ${b.status !== 'cancelled' ? `<button class="action-btn btn-cancel" onclick="updateStatus(${b.booking_id}, 'cancelled')">Hủy</button>` : ''}
                            ${b.status === 'pending' ? `<button class="action-btn btn-approve" onclick="updateStatus(${b.booking_id}, 'confirmed')">Duyệt</button>` : ''}
                        </td>
                    </tr>
                    `;
                }).join('');
            });
        }

        // 4. Tải Tàu & Tuyến vào ô Select
        function loadResourcesForForms() {
            fetch('/api/admin/resources').then(res => res.json()).then(data => {
                const shipSelect = document.getElementById('select-ships');
                shipSelect.innerHTML = data.ships.map(s => `<option value="${s.ship_id}">${s.ship_name} (${s.capacity} chỗ)</option>`).join('');
                
                const routeSelect = document.getElementById('select-routes');
                routeSelect.innerHTML = data.routes.map(r => `<option value="${r.route_id}">${r.from_city} ➝ ${r.to_city}</option>`).join('');
            });
        }

        // 5. Xử lý nút Duyệt/Hủy
        function updateStatus(id, newStatus) {
            if(!confirm('Bạn có chắc chắn muốn thay đổi trạng thái vé #' + id + '?')) return;
            fetch('/admin/update-booking-status', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `booking_id=${id}&status=${newStatus}`
            }).then(() => {
                loadBookings(); // Tải lại bảng sau khi bấm
                loadStats();
            });
        }
    </script>
</body>
</html>