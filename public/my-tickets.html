<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>V√© C·ªßa T√¥i</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root {
    --primary: #0a2540;
    --gold: #d4af37;
    --bg: #f0f2f5;
    --white: #ffffff;
    --shadow: 0 8px 25px rgba(0,0,0,0.08);
}

* { box-sizing: border-box; }

body {
    margin: 0;
    background: var(--bg);
    font-family: 'Poppins', sans-serif;
    color: #2c3e50;
}

.container {
    max-width: 1000px;
    margin: 40px auto;
    background: var(--white);
    padding: 40px;
    border-radius: 20px;
    box-shadow: var(--shadow);
}

.btn-home {
    text-decoration: none;
    color: var(--primary);
    font-weight: 600;
    display: inline-block;
    margin-bottom: 25px;
}

h1 {
    font-size: 1.8rem;
    margin-bottom: 30px;
    color: var(--primary);
    border-bottom: 2px solid var(--gold);
    padding-bottom: 10px;
}

.ticket {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 25px;
    border-radius: 16px;
    border: 1px solid #eee;
    margin-bottom: 20px;
    transition: 0.3s;
}

.ticket:hover {
    transform: translateY(-3px);
    border-color: var(--gold);
    box-shadow: var(--shadow);
}

.ticket h3 {
    margin: 0 0 10px;
    color: var(--primary);
}

.ticket p {
    margin: 4px 0;
    font-size: 0.9rem;
}

.status {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.pending {
    background: #fff8e1;
    color: #9c7a19;
    border: 1px solid #f5d77a;
}

.confirmed {
    background: #e6fffa;
    color: #065f46;
    border: 1px solid #81e6d9;
}

.price {
    margin-top: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--gold);
}

.actions {
    margin-top: 15px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.actions button {
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: 0.2s;
}

.actions button:hover {
    opacity: 0.85;
}

.btn-edit { background: #edf2f7; color: #2d3748; }
.btn-date { background: #e6fffa; color: #065f46; }
.btn-cancel { background: #fff5f5; color: #c53030; }

.empty {
    text-align: center;
    padding: 50px;
    color: #7f8c8d;
}
</style>
</head>

<body>

<div class="container">
    <a href="/" class="btn-home">‚Üê Quay l·∫°i trang ch·ªß</a>
    <h1>L·ªãch S·ª≠ ƒê·∫∑t V√©</h1>
    <div id="ticket-list">ƒêang t·∫£i...</div>
</div>

<script>
fetch('/api/my-booking-history')
.then(res => res.json())
.then(data => {
    const container = document.getElementById('ticket-list');

    if (!data || data.length === 0) {
        container.innerHTML = `<div class="empty">B·∫°n ch∆∞a ƒë·∫∑t chuy·∫øn ƒëi n√†o.</div>`;
        return;
    }

    container.innerHTML = data.map(t => `
        <div class="ticket">
            <div>
                <h3>${t.from_city} ‚ûù ${t.to_city}</h3>
                <p>üïí Kh·ªüi h√†nh: ${new Date(t.departure_time).toLocaleString('vi-VN')}</p>
                <p>üé´ M√£ v√©: <strong>#${t.booking_id}</strong></p>
                <p>üë• S·ªë v√©: ${t.number_of_tickets}</p>
            </div>

            <div style="text-align:right">
                <span class="status ${t.status}">${t.status}</span>
                <div class="price">${Number(t.total_price).toLocaleString()} ƒë</div>

                ${t.status === 'pending' ? `
                <div class="actions">
                    <button class="btn-edit" onclick="editTickets(${t.booking_id}, ${t.number_of_tickets})">‚úèÔ∏è S·ª≠a</button>
                    <button class="btn-date" onclick="changeDate(${t.booking_id})">üìÖ ƒê·ªïi ng√†y</button>
                    <button class="btn-cancel" onclick="cancelBooking(${t.booking_id})">‚ùå H·ªßy</button>
                </div>` : ''}
            </div>
        </div>
    `).join('');
});

// ===== JS C≈® GI·ªÆ NGUY√äN =====
function cancelBooking(id) {
    if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy v√© #' + id + '?')) return;
    fetch('/api/user/cancel-booking', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ booking_id: id })
    }).then(() => location.reload());
}

function editTickets(id, currentQty) {
    const newQty = prompt('Nh·∫≠p s·ªë v√© m·ªõi:', currentQty);
    if (!newQty) return;
    fetch('/api/user/update-tickets', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ booking_id: id, number_of_tickets: newQty })
    }).then(() => location.reload());
}

function changeDate(id) {
    window.location.href = `/change-date.html?booking_id=${id}`;
}
</script>

</body>
</html>
